<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Settings - IP Details</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #2b2d42, #1f2a44);
            color: #e0e0e0;
        }
        .container {
            background: #1e1e2f;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        h1 {
            color: #e0e0e0;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        p {
            font-size: 1.2rem;
            color: #b0b0b0;
            margin: 0.5rem 0;
        }
        .info {
            font-size: 1rem;
            color: #4ea8de;
            word-break: break-all;
            text-align: left;
            margin: 0.5rem 0;
        }
        button {
            margin-top: 1rem;
            width: 100%;
            padding: 0.75rem;
            background: #5e60ce;
            color: #e0e0e0;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #4ea8de;
        }
        #status {
            font-size: 1rem;
            color: #b0b0b0;
            margin-top: 1rem;
        }
        .footer {
            font-size: 0.9rem;
            color: #b0b0b0;
            margin-top: 1rem;
        }
        .footer a {
            color: #4ea8de;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Secret Settings - IP Details</h1>
        <p>IP Address:</p>
        <p class="info" id="ip-address">Fetching...</p>
        <p>City:</p>
        <p class="info" id="city">Fetching...</p>
        <p>Region:</p>
        <p class="info" id="region">Fetching...</p>
        <p>Country:</p>
        <p class="info" id="country">Fetching...</p>
        <p>ISP:</p>
        <p class="info" id="isp">Fetching...</p>
        <p>Organization:</p>
        <p class="info" id="org">Fetching...</p>
        <p>Latitude:</p>
        <p class="info" id="latitude">Fetching...</p>
        <p>Longitude:</p>
        <p class="info" id="longitude">Fetching...</p>
        <p>Postal Code:</p>
        <p class="info" id="postal">Fetching...</p>
        <p>Timezone:</p>
        <p class="info" id="timezone">Fetching...</p>
        <p>ASN:</p>
        <p class="info" id="asn">Fetching...</p>
        <p>User Agent:</p>
        <p class="info" id="user-agent">Fetching...</p>
        <p id="status"></p>
        <button onclick="fetchIPAndDetails()">Refresh</button>
        <button onclick="downloadData()">Download Data</button>
        <p class="footer">Your IP and location details are saved for analytics. Powered by <a href="https://ipapi.co">ipapi.co</a>.</p>
    </div>
    <script>
        async function fetchIPAndDetails() {
            const fields = [
                'ip-address', 'city', 'region', 'country', 'isp', 
                'org', 'latitude', 'longitude', 'postal', 'timezone', 'asn', 'user-agent'
            ];
            const statusDisplay = document.getElementById('status');
            fields.forEach(id => document.getElementById(id).textContent = 'Fetching...');
            statusDisplay.textContent = '';

            try {
                // Fetch IP address
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const ip = ipData.ip;
                document.getElementById('ip-address').textContent = ip;

                // Fetch detailed IP information
                const detailsResponse = await fetch(`https://ipapi.co/${ip}/json/`);
                const detailsData = await detailsResponse.json();
                if (detailsData.error) {
                    throw new Error(detailsData.reason || 'Details fetch failed');
                }

                // Display details
                document.getElementById('city').textContent = detailsData.city || 'Unknown';
                document.getElementById('region').textContent = detailsData.region || 'Unknown';
                document.getElementById('country').textContent = detailsData.country_name || 'Unknown';
                document.getElementById('isp').textContent = detailsData.isp || 'Unknown';
                document.getElementById('org').textContent = detailsData.org || 'Unknown';
                document.getElementById('latitude').textContent = detailsData.latitude || 'Unknown';
                document.getElementById('longitude').textContent = detailsData.longitude || 'Unknown';
                document.getElementById('postal').textContent = detailsData.postal || 'Unknown';
                document.getElementById('timezone').textContent = detailsData.timezone || 'Unknown';
                document.getElementById('asn').textContent = detailsData.asn || 'Unknown';
                document.getElementById('user-agent').textContent = navigator.userAgent || 'Unknown';

                // Prepare data for storage
                const data = {
                    ip,
                    city: detailsData.city || 'Unknown',
                    region: detailsData.region || 'Unknown',
                    country: detailsData.country_name || 'Unknown',
                    isp: detailsData.isp || 'Unknown',
                    org: detailsData.org || 'Unknown',
                    latitude: detailsData.latitude || 'Unknown',
                    longitude: detailsData.longitude || 'Unknown',
                    postal: detailsData.postal || 'Unknown',
                    timezone: detailsData.timezone || 'Unknown',
                    asn: detailsData.asn || 'Unknown',
                    userAgent: navigator.userAgent || 'Unknown',
                    timestamp: new Date().toISOString()
                };

                // Save to localStorage (client-side)
                localStorage.setItem(`visitor_${Date.now()}`, JSON.stringify(data));

                // Send data to Google Apps Script (server-side storage)
                try {
                    const backendResponse = await fetch('https://script.google.com/macros/s/AKfycbyjCdiDY9a22Ml3aGM_L7shsnY1mwGafqKNMoGEO00xel1UUC9g9tUDq3uS8oZIi8xQ4Q/exec', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const backendData = await backendResponse.json();
                    if (backendResponse.ok && backendData.status === 'success') {
                        statusDisplay.textContent = 'Data saved successfully!';
                    } else {
                        throw new Error(backendData.error || 'Failed to save data');
                    }
                } catch (error) {
                    statusDisplay.textContent = 'Error saving data: ' + error.message;
                    console.error('Error:', error);
                }

                // Store data for download
                window.visitorData = data;
            } catch (error) {
                fields.forEach(id => document.getElementById(id).textContent = 'Error fetching data');
                statusDisplay.textContent = 'Error: ' + error.message;
                console.error('Error:', error);
            }
        }

        function downloadData() {
            if (!window.visitorData) {
                alert('No data available to download');
                return;
            }
            const data = window.visitorData;
            const text = [
                `IP Address: ${data.ip}`,
                `City: ${data.city}`,
                `Region: ${data.region}`,
                `Country: ${data.country}`,
                `ISP: ${data.isp}`,
                `Organization: ${data.org}`,
                `Latitude: ${data.latitude}`,
                `Longitude: ${data.longitude}`,
                `Postal Code: ${data.postal}`,
                `Timezone: ${data.timezone}`,
                `ASN: ${data.asn}`,
                `User Agent: ${data.userAgent}`,
                `Timestamp: ${data.timestamp}`
            ].join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `visitor_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Fetch IP and details on page load
        fetchIPAndDetails();
    </script>
</body>
</html>
